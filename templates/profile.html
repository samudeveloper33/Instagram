{% extends 'base.html' %}

{% block title %}Profile - Instagram Clone{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 935px;
        margin: 0 auto;
        padding: 30px 20px;
    }

    .profile-header {
        background: var(--primary-bg);
        padding: 40px 20px 44px;
        margin-bottom: 44px;
    }

    .profile-main-content {
        display: flex;
        align-items: flex-start;
        gap: 80px;
        max-width: 935px;
        margin: 0 auto;
    }

    .profile-avatar-section {
        position: relative;
        flex-shrink: 0;
    }

    .profile-avatar-wrapper {
        position: relative;
        display: inline-block;
    }

    .profile-avatar-ring {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        padding: 3px;
        background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        cursor: pointer;
        display: inline-block;
    }

    .profile-avatar-ring.no-story {
        background: transparent;
        padding: 0;
    }

    .profile-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
        background: #c4c4c4;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border: 3px solid var(--primary-bg);
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .profile-avatar .camera-icon {
        position: absolute;
        color: white;
        font-size: 48px;
    }


    .profile-info-section {
        flex: 1;
        min-width: 0;
    }

    .profile-top-bar {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        width: 100%;
    }

    .profile-username {
        font-size: 28px;
        font-weight: 300;
        color: var(--text-primary);
    }

    .edit-profile-btn,
    .follow-btn {
        padding: 7px 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--primary-bg);
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 90px;
        transition: background-color 0.2s ease;
    }

    .edit-profile-btn:hover {
        background-color: var(--secondary-bg);
    }

    .settings-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: var(--text-primary);
        padding: 8px;
        border-radius: 8px;
        transition: background-color 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .settings-icon:hover {
        background-color: var(--secondary-bg);
    }

    .follow-btn {
        background-color: var(--link-color);
        color: white;
        border: none;
    }

    .profile-stats {
        display: flex;
        align-items: center;
        gap: 40px;
        margin-bottom: 20px;
    }

    .stat {
        font-size: 16px;
        display: flex;
        gap: 4px;
        color: var(--text-primary);
    }

    .stat-value {
        font-weight: 600;
    }

    .profile-name {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 16px;
        color: var(--text-primary);
    }

    .profile-bio {
        font-size: 14px;
        margin-bottom: 4px;
        line-height: 1.4;
        color: var(--text-primary);
    }

    .profile-website {
        font-size: 14px;
        margin-bottom: 20px;
    }

    .profile-website a {
        color: #00376b;
        font-weight: 600;
        text-decoration: none;
    }

    .add-story-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--link-color);
        color: white;
        border: 3px solid var(--primary-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        transition: transform 0.2s;
    }

    .add-story-btn:hover {
        transform: scale(1.1);
    }

    .new-highlight-btn {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        margin-top: 20px;
    }

    .new-highlight-circle {
        width: 77px;
        height: 77px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: var(--text-secondary);
        background: var(--primary-bg);
    }

    .new-highlight-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .add-story-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--link-color);
        color: white;
        border: 3px solid var(--primary-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        transition: transform 0.2s;
    }

    .add-story-btn:hover {
        transform: scale(1.1);
    }

    .story-highlight-section {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    .highlight-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        min-width: 77px;
    }

    .highlight-ring {
        width: 77px;
        height: 77px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        padding: 2px;
        margin-bottom: 4px;
    }

    .highlight-ring img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .highlight-label {
        font-size: 12px;
        max-width: 77px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-align: center;
    }

    /* Posts Grid */
    .profile-tabs {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 60px;
        border-top: 1px solid var(--border-color);
        padding: 16px 0;
    }

    .profile-tab {
        cursor: pointer;
        font-size: 24px;
        color: var(--text-secondary);
        opacity: 0.3;
        transition: opacity 0.2s;
    }

    .profile-tab.active {
        color: var(--text-primary);
        opacity: 1;
    }

    .profile-tab:hover {
        opacity: 0.6;
    }

    .posts-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 28px;
        margin-top: 40px;
    }

    .post-thumbnail {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
        cursor: pointer;
    }

    .post-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .post-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        justify-content: center;
        gap: 30px;
        color: white;
        font-weight: 600;
    }

    .post-thumbnail:hover .post-overlay {
        display: flex;
    }

    .no-posts {
        text-align: center;
        padding: 100px 20px;
        color: var(--text-primary);
        grid-column: 1 / -1;
    }

    .no-posts .icon-circle {
        width: 96px;
        height: 96px;
        border-radius: 50%;
        border: 3px solid var(--text-primary);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        margin-bottom: 20px;
    }

    .no-posts h2 {
        font-size: 28px;
        font-weight: 300;
        margin-bottom: 8px;
    }

    /* Edit Profile Modal */
    .avatar-upload {
        text-align: center;
        margin-bottom: 20px;
    }

    .avatar-upload img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 10px;
    }

    .avatar-upload label {
        color: var(--link-color);
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
    }

    .avatar-upload input {
        display: none;
    }

    /* Settings Modal */
    .settings-menu {
        padding: 0;
    }

    .settings-option {
        width: 100%;
        padding: 14px 16px;
        border: none;
        background: none;
        text-align: center;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: background-color 0.2s;
        color: var(--text-primary);
    }

    .settings-option:not(:last-child) {
        border-bottom: 1px solid var(--border-color);
    }

    .settings-option:hover {
        background-color: var(--secondary-bg);
    }

    .settings-option i {
        font-size: 16px;
    }

    /* Followers/Following Modal */
    .user-list-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px;
        transition: background-color 0.2s;
    }

    .user-list-item:hover {
        background-color: var(--secondary-bg);
    }

    .user-list-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--border-color);
    }

    .user-list-info {
        flex: 1;
    }

    .user-list-username {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
        text-decoration: none;
        display: block;
    }

    .user-list-name {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .follow-btn-modal {
        background: var(--link-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 16px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
    }

    .follow-btn-modal.following {
        background: var(--secondary-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .stat-item {
        cursor: pointer;
    }

    .stat-item:hover {
        opacity: 0.7;
    }

    .suggestions-header {
        padding: 16px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        border-top: 1px solid var(--border-color);
    }

    .user-list-subtitle {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    /* Post Detail Modal Styles */
    .post-nav-btn {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        z-index: 10;
        transition: all 0.2s;
    }

    .post-nav-btn:hover {
        background: white;
        transform: scale(1.1);
    }

    .post-nav-btn:active {
        transform: scale(0.95);
    }

    /* Post Options Menu */
    .post-options-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        cursor: pointer;
        font-size: 24px;
        padding: 8px 12px;
        color: var(--text-primary);
        z-index: 11;
        transition: all 0.2s;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .post-options-btn:hover {
        transform: scale(1.1);
        background: white;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }

    .post-options-btn:active {
        transform: scale(0.95);
    }

    .post-options-menu {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 400px;
        max-width: 400px;
        z-index: 3000;  /* Higher than modal (2000) */
        overflow: hidden;
        display: none;
        animation: fadeIn 0.2s ease-in-out;
    }

    .post-options-menu.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translate(-50%, -48%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    .post-option-item {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border-color);
        text-align: center;
        cursor: pointer;
        font-size: 14px;
        background: white;
        transition: background-color 0.2s;
    }

    .post-option-item:last-child {
        border-bottom: none;
    }

    .post-option-item:hover {
        background-color: var(--secondary-bg);
    }

    .post-option-item.danger {
        color: #ed4956;
        font-weight: 700;
    }

    .post-option-item.cancel {
        border-top: 6px solid var(--border-color);
    }

    .post-options-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);  /* Slightly lighter overlay */
        z-index: 2500;  /* Higher than modal but lower than menu */
        display: none;
        animation: overlayFadeIn 0.2s ease-in-out;
    }

    .post-options-overlay.active {
        display: block;
    }

    @keyframes overlayFadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .profile-container {
            padding: 20px 0;
        }

        .profile-header {
            padding: 20px 16px 32px;
        }

        .profile-main-content {
            flex-direction: column;
            align-items: center;
            gap: 30px;
            text-align: center;
        }

        .profile-info-section {
            width: 100%;
        }

        .profile-top-bar {
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .profile-username {
            font-size: 24px;
            width: 100%;
            text-align: center;
        }

        .profile-stats {
            justify-content: center;
            gap: 30px;
            text-align: center;
        }

        .profile-avatar-ring {
            width: 77px;
            height: 77px;
        }

        .profile-avatar .camera-icon {
            font-size: 32px;
        }


        .edit-profile-btn,
        .follow-btn {
            padding: 6px 14px;
            font-size: 13px;
            min-width: 80px;
        }

        .settings-icon {
            font-size: 20px;
        }

        .profile-name {
            text-align: center;
        }

        .profile-bio {
            text-align: center;
        }

        .profile-website {
            text-align: center;
        }
        
        /* Make post modal responsive on mobile */
        #postDetailModal .modal-content {
            max-width: 95vw;
            max-height: 95vh;
        }
        
        .post-nav-btn {
            width: 32px;
            height: 32px;
            font-size: 16px;
        }
        
        .post-options-menu {
            min-width: 90vw;
            max-width: 90vw;
        }
        
        .post-options-btn {
            font-size: 20px;
            top: 12px;
            right: 12px;
        }

        .profile-tabs {
            gap: 40px;
        }

        .posts-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-top: 0;
        }

        .new-highlight-circle {
            width: 62px;
            height: 62px;
            font-size: 32px;
        }

        .new-highlight-label {
            font-size: 11px;
        }

        /* Mobile-specific modal improvements */
        #removeFollowerModal .modal-content,
        #unfollowModal .modal-content {
            width: 90%;
            max-width: 350px;
            margin: 20px auto;
        }

        #removeFollowerModal .settings-option,
        #unfollowModal .settings-option {
            padding: 16px;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.2s;
        }

        #removeFollowerModal .settings-option:active,
        #unfollowModal .settings-option:active {
            background-color: var(--secondary-bg);
        }

        /* Improve followers/following modal on mobile */
        #followersModal .modal-content,
        #followingModal .modal-content {
            width: 95%;
            max-width: 95%;
            height: 80vh;
            margin: 10vh auto;
        }

        #followersModal .modal-body,
        #followingModal .modal-body {
            max-height: calc(80vh - 120px);
        }

        .user-list-item {
            padding: 12px 16px;
            -webkit-tap-highlight-color: transparent;
        }

        .user-list-item .remove-btn {
            padding: 6px 12px;
            font-size: 14px;
            -webkit-tap-highlight-color: transparent;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="profileContainer">
    <div class="loading" style="text-align: center; padding: 40px;">Loading profile...</div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Profile</h3>
            <button class="close-modal" onclick="closeModal('editProfileModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editProfileForm">
                <div class="avatar-upload">
                    <img id="avatarPreview" src="" alt="Avatar">
                    <label for="avatarInput">Change Profile Photo</label>
                    <input type="file" id="avatarInput" name="avatar" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea name="bio" id="bioInput"></textarea>
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" name="website" id="websiteInput" placeholder="https://example.com">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>
</div>

<!-- Post Detail Modal -->
<div id="postDetailModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3>Post</h3>
            <button class="close-modal" onclick="closeModal('postDetailModal')">&times;</button>
        </div>
        <div class="modal-body" id="postDetailContent">
        </div>
    </div>
</div>

<!-- Post Options Menu -->
<div class="post-options-overlay" id="postOptionsOverlay" onclick="closePostOptionsMenu()"></div>
<div class="post-options-menu" id="postOptionsMenu">
    <div class="post-option-item danger" onclick="deletePost()">Delete</div>
    <div class="post-option-item" onclick="editPost()">Edit</div>
    <div class="post-option-item cancel" onclick="closePostOptionsMenu()">Cancel</div>
</div>

<!-- Share Post Modal -->
<div id="shareModal" class="modal">
    <div class="modal-content" style="max-width: 550px; padding: 0;">
        <div class="modal-header" style="padding: 16px; border-bottom: 1px solid var(--border-color);">
            <h3 style="font-size: 16px; font-weight: 600;">Share</h3>
            <button class="close-modal" onclick="closeModal('shareModal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <!-- Selected users chips -->
            <div id="selectedUsersChips" style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: none; flex-wrap: wrap; gap: 8px; align-items: center;">
                <span style="font-weight: 600; font-size: 14px; color: var(--text-secondary);">To:</span>
            </div>
            
            <!-- Search bar -->
            <div class="messages-search" style="padding: 16px; border-bottom: 1px solid var(--border-color);">
                <input type="text" id="shareSearchInput" placeholder="Search..." 
                       style="width: 100%; padding: 8px 16px; background: var(--secondary-bg); border: none; border-radius: 8px; font-size: 14px;"
                       oninput="filterShareUsers(this.value)">
            </div>
            
            <!-- Users list -->
            <div id="shareUsersList" style="padding: 8px 0; max-height: 300px; overflow-y: auto;">
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    Loading users...
                </div>
            </div>
            
            <!-- Message input and send button -->
            <div id="shareMessageSection" style="padding: 16px; border-top: 1px solid var(--border-color); display: none;">
                <textarea id="shareMessageInput" placeholder="Write a message..." 
                          style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-family: inherit; resize: none; min-height: 60px; margin-bottom: 12px;"></textarea>
                <button onclick="sendSharedPost()" style="width: 100%; padding: 12px; background: var(--link-color); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">
                    Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content" style="max-width: 400px; border-radius: 12px;">
        <div class="settings-menu">
            <button class="settings-option" style="border-top: 1px solid var(--border-color); color: #ed4956;" onclick="logout()">
                <span>Log out</span>
            </button>
            <button class="settings-option" onclick="closeModal('settingsModal')">
                <span>Cancel</span>
            </button>
        </div>
    </div>
</div>

<!-- Followers Modal -->
<div id="followersModal" class="modal">
    <div class="modal-content" style="max-width: 400px; border-radius: 12px; max-height: 500px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color); padding: 8px 16px;">
            <h3 style="font-size: 16px; font-weight: 600; text-align: center;">Followers</h3>
            <button class="close-modal" onclick="closeModal('followersModal')">&times;</button>
        </div>
        <div style="padding: 8px 16px; border-bottom: 1px solid var(--border-color);">
            <input type="text" id="followersSearch" placeholder="Search" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--secondary-bg); outline: none;">
        </div>
        <div class="modal-body" style="padding: 8px 0; max-height: 350px; overflow-y: auto;">
            <div id="followersListContainer">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
</div>

<!-- Following Modal -->
<div id="followingModal" class="modal">
    <div class="modal-content" style="max-width: 400px; border-radius: 12px; max-height: 500px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color); padding: 8px 16px;">
            <h3 style="font-size: 16px; font-weight: 600; text-align: center;">Following</h3>
            <button class="close-modal" onclick="closeModal('followingModal')">&times;</button>
        </div>
        <div style="padding: 8px 16px; border-bottom: 1px solid var(--border-color);">
            <input type="text" id="followingSearch" placeholder="Search" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--secondary-bg); outline: none;">
        </div>
        <div class="modal-body" style="padding: 8px 0; max-height: 350px; overflow-y: auto;">
            <div id="followingListContainer">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
</div>

<!-- Unfollow Confirmation Modal -->
<div id="unfollowModal" class="modal">
    <div class="modal-content" style="max-width: 400px; border-radius: 12px; text-align: center; padding: 32px 16px;">
        <img id="unfollowUserAvatar" src="" alt="" style="width: 90px; height: 90px; border-radius: 50%; margin-bottom: 20px; object-fit: cover;">
        <p id="unfollowMessage" style="font-size: 14px; color: var(--text-primary); margin-bottom: 24px;"></p>
        <button class="settings-option" onclick="confirmUnfollow()" style="width: 100%; color: #ed4956; font-weight: 700; border-bottom: 1px solid var(--border-color); padding: 14px;">Unfollow</button>
        <button class="settings-option" onclick="closeModal('unfollowModal')" style="width: 100%; padding: 14px;">Cancel</button>
    </div>
</div>

<!-- Remove Follower Confirmation Modal -->
<div id="removeFollowerModal" class="modal">
    <div class="modal-content" style="max-width: 400px; border-radius: 12px; text-align: center; padding: 32px 16px;">
        <img id="removeFollowerUserAvatar" src="" alt="" style="width: 90px; height: 90px; border-radius: 50%; margin-bottom: 20px; object-fit: cover;">
        <p id="removeFollowerMessage" style="font-size: 14px; color: var(--text-primary); margin-bottom: 24px;"></p>
        <button class="settings-option" onclick="confirmRemoveFollower()" style="width: 100%; color: #ed4956; font-weight: 700; border-bottom: 1px solid var(--border-color); padding: 14px;">Remove</button>
        <button class="settings-option" onclick="closeModal('removeFollowerModal')" style="width: 100%; padding: 14px;">Cancel</button>
    </div>
</div>

<!-- Add Story Modal -->
<div id="addStoryModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Create Story</h3>
            <button class="close-modal" onclick="closeModal('addStoryModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addStoryForm">
                <div class="form-group">
                    <label>Upload Image</label>
                    <input type="file" id="storyImageInput" name="image" accept="image/*" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                </div>
                <div id="storyPreviewContainer" style="margin: 16px 0; text-align: center; display: none;">
                    <img id="storyPreview" src="" alt="Story preview" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Share Story</button>
            </form>
        </div>
    </div>
</div>

<!-- View Story Modal -->
<div id="viewStoryModal" class="modal" style="background: rgba(0, 0, 0, 0.9);">
    <div class="modal-content" style="max-width: 500px; background: transparent; box-shadow: none; position: relative;">
        <button class="close-modal" onclick="closeModal('viewStoryModal')" style="position: absolute; top: 20px; right: 20px; z-index: 10; background: rgba(255,255,255,0.3); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer;">&times;</button>
        <div id="storyViewContent" style="text-align: center;">
            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(0,0,0,0.5); border-radius: 8px;">
                <img id="storyViewerAvatar" src="" alt="" style="width: 44px; height: 44px; border-radius: 50%; border: 2px solid white;">
                <div style="flex: 1; text-align: left;">
                    <div id="storyViewerUsername" style="color: white; font-weight: 600; font-size: 14px;"></div>
                    <div id="storyViewerTime" style="color: rgba(255,255,255,0.7); font-size: 12px;"></div>
                </div>
            </div>
            <img id="storyViewImage" src="" alt="Story" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentProfile = null;
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const username = pathParts.length > 1 ? pathParts[1] : 'me';

    async function loadProfile() {
        try {
            const endpoint = username === 'me' || !username || username === 'profile'
                ? '/profile/me/' 
                : `/profile/${username}/`;
            
            const profile = await apiCall(endpoint);
            currentProfile = profile;
            renderProfile(profile);
            loadUserPosts(profile.username);
        } catch (error) {
            console.error('Error loading profile:', error);
            document.getElementById('profileContainer').innerHTML = 
                '<div class="loading">Failed to load profile</div>';
        }
    }

    let userStories = [];
    let hasActiveStory = false;

    function renderProfile(profile) {
        const isOwnProfile = !username || username === 'me' || username === 'profile';
        const hasAvatar = profile.avatar && profile.avatar !== getDefaultAvatar(150);
        
        const html = `
            <div class="profile-header">
                <div class="profile-main-content">
                    <!-- Left Side: Profile Image -->
                    <div class="profile-avatar-section">
                        <div class="profile-avatar-wrapper">
                            <div class="profile-avatar-ring ${hasActiveStory ? '' : 'no-story'}" onclick="${hasActiveStory ? 'viewProfileStory()' : (isOwnProfile ? 'openEditModal()' : '')}">
                                <div class="profile-avatar">
                                    ${hasAvatar ? `
                                        <img src="${profile.avatar}" alt="${profile.username}">
                                    ` : `
                                        <i class="fas fa-camera camera-icon"></i>
                                    `}
                                </div>
                            </div>
                            ${isOwnProfile ? `
                                <button class="add-story-btn" onclick="openAddStoryModal()" title="Add Story">+</button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Right Side: Profile Info -->
                    <div class="profile-info-section">
                        <!-- Line 1: Username + Edit Profile + Settings -->
                        <div class="profile-top-bar">
                            <span class="profile-username">${profile.username}</span>
                            ${isOwnProfile ? `
                                <button class="edit-profile-btn" onclick="openEditModal()">Edit profile</button>
                                <button class="settings-icon" onclick="openSettings()">
                                    <i class="fas fa-cog"></i>
                                </button>
                            ` : `
                                <button class="follow-btn" onclick="toggleFollow('${profile.username}', this)">
                                    ${profile.is_following ? 'Unfollow' : 'Follow'}
                                </button>
                            `}
                        </div>

                        <!-- Line 2: Posts, Followers, Following Stats -->
                        <div class="profile-stats">
                            <div class="stat stat-item">
                                <span class="stat-value">${profile.posts_count}</span> <span>posts</span>
                            </div>
                            <div class="stat stat-item" onclick="openFollowersModal()">
                                <span class="stat-value">${profile.followers_count}</span> <span>followers</span>
                            </div>
                            <div class="stat stat-item" onclick="openFollowingModal()">
                                <span class="stat-value">${profile.following_count}</span> <span>following</span>
                            </div>
                        </div>

                        <!-- Line 3: User Name -->
                        <div class="profile-name">${profile.username}</div>

                        <!-- Line 4: Bio -->
                        ${profile.bio ? `
                            <div class="profile-bio">${profile.bio}</div>
                        ` : ''}

                        <!-- Line 5: Website -->
                        ${profile.website ? `
                            <div class="profile-website">
                                <a href="${profile.website}" target="_blank">${profile.website}</a>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>

            <div class="profile-tabs">
                <div class="profile-tab active" data-tab="posts">
                    <i class="fas fa-th"></i>
                </div>
            </div>

            <div class="posts-grid" id="postsGrid">
                <div class="loading">Loading posts...</div>
            </div>
        `;

        document.getElementById('profileContainer').innerHTML = html;
    }

    async function loadUserPosts(username) {
        try {
            const posts = await apiCall(`/posts/user/${username}/`);
            const grid = document.getElementById('postsGrid');
            
            if (posts.length === 0) {
                grid.innerHTML = `
                    <div class="no-posts">
                        <h2>Photos of you</h2>
                        <p style="color: var(--text-secondary); font-size: 14px;">When people tag you in photos, they'll appear here.</p>
                    </div>
                `;
                return;
            }

            // Store all posts for navigation
            allUserPosts = posts;
            
            grid.innerHTML = posts.map(post => `
                <div class="post-thumbnail" onclick="showPostDetail(${post.id})">
                    ${post.video ? 
                        `<video src="${post.video}" style="width: 100%; height: 100%; object-fit: cover;"></video>` :
                        `<img src="${post.image}" alt="Post">`
                    }
                    <div class="post-overlay">
                        <span><i class="fas fa-heart"></i> ${post.likes_count}</span>
                        <span><i class="fas fa-comment"></i> ${post.comments_count}</span>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading posts:', error);
            document.getElementById('postsGrid').innerHTML = 
                '<div class="loading" style="grid-column: 1 / -1;">Failed to load posts</div>';
        }
    }

    function openEditModal() {
        document.getElementById('bioInput').value = currentProfile.bio || '';
        document.getElementById('websiteInput').value = currentProfile.website || '';
        const avatarPreview = document.getElementById('avatarPreview');
        avatarPreview.src = safeImageSrc(currentProfile.avatar, 100);
        avatarPreview.onerror = function() { this.src = getDefaultAvatar(100); };
        document.getElementById('editProfileModal').classList.add('active');
    }

    // Avatar preview
    document.getElementById('avatarInput')?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('avatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Submit edit profile
    document.getElementById('editProfileForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
            await apiCall('/profile/me/', {
                method: 'PATCH',
                body: formData
            });

            closeModal('editProfileModal');
            loadProfile();
        } catch (error) {
            console.error('Error updating profile:', error);
            alert('Failed to update profile');
        }
    });

    async function toggleFollow(username, button) {
        try {
            const response = await apiCall(`/profile/${username}/follow/`, { method: 'POST' });
            
            if (response.status === 'followed') {
                button.textContent = 'Unfollow';
            } else {
                button.textContent = 'Follow';
            }
            
            loadProfile();
        } catch (error) {
            console.error('Error toggling follow:', error);
        }
    }

    async function messageUser(username) {
        try {
            const response = await apiCall('/conversations/create/', {
                method: 'POST',
                body: JSON.stringify({ username })
            });
            
            if (response.conversation_id) {
                window.location.href = `/messages?conversation=${response.conversation_id}`;
            }
        } catch (error) {
            console.error('Error creating conversation:', error);
        }
    }

    // Message user from modal (closes modal and redirects)
    async function messageUserFromModal(username) {
        try {
            // Close the followers modal first
            closeModal('followersModal');
            
            const response = await apiCall('/conversations/create/', {
                method: 'POST',
                body: JSON.stringify({ username })
            });
            
            if (response.conversation_id) {
                window.location.href = `/messages?conversation=${response.conversation_id}`;
            }
        } catch (error) {
            console.error('Error creating conversation:', error);
            alert('Failed to create conversation. Please try again.');
        }
    }

    async function showPostDetail(postId) {
        try {
            // Find the index of clicked post
            currentPostIndex = allUserPosts.findIndex(p => p.id === postId);
            if (currentPostIndex === -1) currentPostIndex = 0;
            
            await renderPostDetail();
        } catch (error) {
            console.error('Error loading post:', error);
        }
    }

    async function renderPostDetail() {
        try {
            const post = allUserPosts[currentPostIndex];
            if (!post) return;
            
            // Fetch full post details
            const fullPost = await apiCall(`/posts/${post.id}/`);
            
            const hasPrev = currentPostIndex > 0;
            const hasNext = currentPostIndex < allUserPosts.length - 1;
            
            const html = `
                <div style="display: flex; gap: 20px; position: relative;">
                    <!-- Three dots menu button -->
                    <button onclick="openPostOptionsMenu(${fullPost.id})" class="post-options-btn">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    
                    ${hasPrev ? `
                        <button onclick="navigateToPreviousPost()" class="post-nav-btn" style="left: 10px; top: 50%; transform: translateY(-50%);">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    ` : ''}
                    
                    ${hasNext ? `
                        <button onclick="navigateToNextPost()" class="post-nav-btn" style="right: 10px; top: 50%; transform: translateY(-50%);">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    ` : ''}
                    
                    <div style="flex: 1; max-width: 600px; cursor: pointer;" onclick="${hasNext ? 'navigateToNextPost()' : ''}">
                        ${fullPost.video ? 
                            `<video src="${fullPost.video}" controls style="width: 100%; height: auto; object-fit: contain;"></video>` :
                            `<img src="${fullPost.image}" style="width: 100%; height: auto; object-fit: contain;">`
                        }
                    </div>
                    
                    <div style="flex: 1; min-width: 300px; display: flex; flex-direction: column;">
                        <div style="display: flex; align-items: center; gap: 10px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                            <img src="${fullPost.author_avatar || getDefaultAvatar(32)}" 
                                 style="width: 32px; height: 32px; border-radius: 50%;">
                            <strong>${fullPost.author_username}</strong>
                        </div>
                        <div style="padding: 16px 0; flex: 1; overflow-y: auto;">
                            ${fullPost.caption ? `<p><strong>${fullPost.author_username}</strong> ${fullPost.caption}</p>` : ''}
                            <div style="margin-top: 16px;">
                                ${fullPost.comments.map(c => `
                                    <p style="margin: 8px 0;">
                                        <strong>${c.author_username}</strong> ${c.text}
                                    </p>
                                `).join('')}
                            </div>
                        </div>
                        <div style="margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div style="display: flex; gap: 16px; margin-bottom: 12px; align-items: center;">
                                <button onclick="toggleLikeInModal(${fullPost.id}, this)" style="background: none; border: none; cursor: pointer; font-size: 24px;">
                                    <i class="${fullPost.is_liked ? 'fas' : 'far'} fa-heart" style="color: ${fullPost.is_liked ? '#ed4956' : 'inherit'}"></i>
                                </button>
                                <button style="background: none; border: none; cursor: pointer; font-size: 24px;">
                                    <i class="far fa-comment"></i>
                                </button>
                                <button onclick="openShareModal(${fullPost.id})" style="background: none; border: none; cursor: pointer; font-size: 24px;">
                                    <i class="far fa-paper-plane"></i>
                                </button>
                            </div>
                            <p style="color: var(--text-primary); font-weight: 600; font-size: 14px; margin-bottom: 8px;">
                                ${fullPost.likes_count} likes
                            </p>
                            <p style="color: var(--text-secondary); font-size: 10px; text-transform: uppercase;">
                                ${formatDate(fullPost.created_at)}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('postDetailContent').innerHTML = html;
            document.getElementById('postDetailModal').classList.add('active');
        } catch (error) {
            console.error('Error rendering post:', error);
        }
    }

    function navigateToNextPost() {
        if (currentPostIndex < allUserPosts.length - 1) {
            currentPostIndex++;
            renderPostDetail();
        }
    }

    function navigateToPreviousPost() {
        if (currentPostIndex > 0) {
            currentPostIndex--;
            renderPostDetail();
        }
    }

    async function toggleLikeInModal(postId, button) {
        try {
            await apiCall(`/posts/${postId}/like/`, { method: 'POST' });
            
            // Reload the current post to get updated like status
            const post = await apiCall(`/posts/${postId}/`);
            
            const icon = button.querySelector('i');
            if (post.is_liked) {
                icon.className = 'fas fa-heart';
                icon.style.color = '#ed4956';
            } else {
                icon.className = 'far fa-heart';
                icon.style.color = 'inherit';
            }
            
            // Update like count
            const likeCountText = button.closest('div').parentElement.querySelector('p');
            likeCountText.textContent = `${post.likes_count} likes`;
            
            // Update in the posts array
            allUserPosts[currentPostIndex] = post;
        } catch (error) {
            console.error('Error toggling like:', error);
        }
    }

    async function toggleSaveInModal(postId, button) {
        try {
            const response = await apiCall(`/posts/${postId}/save/`, {
                method: 'POST'
            });
            
            const icon = button.querySelector('i');
            if (response.saved) {
                icon.className = 'fas fa-bookmark';
            } else {
                icon.className = 'far fa-bookmark';
            }
            
            // Show feedback toast
            const feedback = document.createElement('div');
            feedback.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; font-size: 14px;';
            feedback.textContent = response.saved ? 'Post saved' : 'Post removed from saved';
            document.body.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 2000);
        } catch (error) {
            console.error('Error toggling save:', error);
            alert('Failed to save post. Please try again.');
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'just now';
        if (minutes < 60) return `${minutes} minutes ago`;
        if (hours < 24) return `${hours} hours ago`;
        if (days < 7) return `${days} days ago`;
        
        return date.toLocaleDateString();
    }

    // Keyboard navigation for post modal
    document.addEventListener('keydown', (e) => {
        const postModal = document.getElementById('postDetailModal');
        if (!postModal || !postModal.classList.contains('active')) return;
        
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateToNextPost();
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateToPreviousPost();
        } else if (e.key === 'Escape') {
            closeModal('postDetailModal');
        }
    });

    // Post Options Menu Functions
    let currentPostIdForMenu = null;

    function openPostOptionsMenu(postId) {
        currentPostIdForMenu = postId;
        document.getElementById('postOptionsMenu').classList.add('active');
        document.getElementById('postOptionsOverlay').classList.add('active');
    }

    function closePostOptionsMenu() {
        document.getElementById('postOptionsMenu').classList.remove('active');
        document.getElementById('postOptionsOverlay').classList.remove('active');
    }

    async function deletePost() {
        // Close the menu first
        closePostOptionsMenu();
        
        try {
            console.log('Deleting post ID:', currentPostIdForMenu);
            const result = await apiCall(`/posts/${currentPostIdForMenu}/`, { method: 'DELETE' });
            console.log('Delete result:', result);
            
            // Close the post detail modal
            closeModal('postDetailModal');
            
            // Reload posts grid
            if (currentProfile) {
                await loadUserPosts(currentProfile.username);
            }
        } catch (error) {
            console.error('Error deleting post:', error);
            console.error('Error details:', error.message, error.stack);
            alert(`Failed to delete post: ${error.message}`);
        }
    }

    function editPost() {
        closePostOptionsMenu();
        
        // Get current post data
        const post = allUserPosts.find(p => p.id === currentPostIdForMenu);
        if (!post) {
            alert('Post not found');
            return;
        }
        
        // Prompt for new caption
        const newCaption = prompt('Edit caption:', post.caption || '');
        
        if (newCaption === null) {
            // User cancelled
            return;
        }
        
        // Update caption via API
        updatePostCaption(currentPostIdForMenu, newCaption);
    }

    async function updatePostCaption(postId, caption) {
        try {
            await apiCall(`/posts/${postId}/`, {
                method: 'PATCH',
                body: JSON.stringify({ caption })
            });
            
            // Update in local data
            const post = allUserPosts.find(p => p.id === postId);
            if (post) {
                post.caption = caption;
            }
            
            // Refresh the post detail if open
            if (document.getElementById('postDetailModal').classList.contains('active')) {
                showPostDetail(postId);
            }
            
            
        } catch (error) {
            console.error('Error updating caption:', error);
            alert('Failed to update caption. Please try again.');
        }
    }

    function hideLikeCount() {
        closePostOptionsMenu();
        alert('Hide like count feature coming soon!');
    }

    function turnOffCommenting() {
        closePostOptionsMenu();
        alert('Turn off commenting feature coming soon!');
    }

    function goToPostPage() {
        closePostOptionsMenu();
        window.location.href = `/post/${currentPostIdForMenu}`;
    }

    function sharePost() {
        closePostOptionsMenu();
        alert('Share post feature coming soon!');
    }

    function copyPostLink() {
        const postLink = `${window.location.origin}/post/${currentPostIdForMenu}`;
        navigator.clipboard.writeText(postLink).then(() => {
            closePostOptionsMenu();
            alert('Link copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy link:', err);
            alert('Failed to copy link. Please try again.');
        });
    }

    function embedPost() {
        closePostOptionsMenu();
        alert('Embed post feature coming soon!');
    }

    function aboutThisAccount() {
        closePostOptionsMenu();
        alert('About this account feature coming soon!');
    }

    // Share Post Functions
    let currentSharePostId = null;
    let allShareUsers = [];
    let selectedShareUsers = [];

    async function openShareModal(postId) {
        currentSharePostId = postId;
        selectedShareUsers = [];
        document.getElementById('shareModal').classList.add('active');
        document.getElementById('selectedUsersChips').style.display = 'none';
        document.getElementById('shareMessageSection').style.display = 'none';
        document.getElementById('shareSearchInput').value = '';
        
        // Load following users
        try {
            const following = await apiCall(`/profile/${currentProfile.username}/following/`);
            allShareUsers = following;
            renderShareUsers(following);
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('shareUsersList').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Failed to load users</div>';
        }
    }

    function renderShareUsers(users) {
        const container = document.getElementById('shareUsersList');
        
        if (users.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No users to share with. Follow someone first!</div>';
            return;
        }
        
        container.innerHTML = users.map(user => {
            const isSelected = selectedShareUsers.some(u => u.username === user.username);
            return `
                <div class="user-list-item" data-username="${user.username}" style="padding: 8px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; background: ${isSelected ? 'var(--secondary-bg)' : 'transparent'};" 
                     onmouseover="if(!${isSelected}) this.style.background='var(--secondary-bg)'" 
                     onmouseout="if(!${isSelected}) this.style.background='transparent'"
                     onclick="toggleSelectUser('${user.username}', '${user.profile?.avatar || getDefaultAvatar(44)}')">
                    <img src="${user.profile?.avatar || getDefaultAvatar(44)}" 
                         alt="${user.username}" 
                         style="width: 44px; height: 44px; border-radius: 50%; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">${user.username}</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">${user.username}</div>
                    </div>
                    <div class="share-check" style="display: ${isSelected ? 'block' : 'none'}; color: var(--link-color);">
                        <i class="fas fa-check-circle" style="font-size: 24px;"></i>
                    </div>
                </div>
            `;
        }).join('');
    }

    function toggleSelectUser(username, avatar) {
        const index = selectedShareUsers.findIndex(u => u.username === username);
        
        if (index > -1) {
            // Remove from selection
            selectedShareUsers.splice(index, 1);
        } else {
            // Add to selection
            selectedShareUsers.push({ username, avatar });
        }
        
        // Update UI
        updateSelectedChips();
        renderShareUsers(allShareUsers);
        
        // Show/hide message section
        const messageSection = document.getElementById('shareMessageSection');
        messageSection.style.display = selectedShareUsers.length > 0 ? 'block' : 'none';
    }

    function updateSelectedChips() {
        const chipsContainer = document.getElementById('selectedUsersChips');
        
        if (selectedShareUsers.length === 0) {
            chipsContainer.style.display = 'none';
            return;
        }
        
        chipsContainer.style.display = 'flex';
        chipsContainer.innerHTML = `
            <span style="font-weight: 600; font-size: 14px; color: var(--text-secondary);">To:</span>
            ${selectedShareUsers.map(user => `
                <div style="display: flex; align-items: center; gap: 6px; background: var(--link-color); color: white; padding: 4px 8px 4px 4px; border-radius: 16px; font-size: 12px;">
                    <img src="${user.avatar}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover;">
                    <span>${user.username}</span>
                    <button onclick="event.stopPropagation(); toggleSelectUser('${user.username}', '${user.avatar}')" 
                            style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin-left: 2px; font-size: 16px; line-height: 1;">
                        
                    </button>
                </div>
            `).join('')}
        `;
    }

    function filterShareUsers(searchTerm) {
        const filtered = allShareUsers.filter(user => 
            user && user.username && user.username.toLowerCase().includes(searchTerm.toLowerCase())
        );
        renderShareUsers(filtered);
    }

    async function sendSharedPost() {
        if (selectedShareUsers.length === 0) {
            alert('Please select at least one person to share with');
            return;
        }
        
        const customMessage = document.getElementById('shareMessageInput').value.trim();
        const postLink = `${window.location.origin}/post/${currentSharePostId}`;
        const messageText = customMessage 
            ? `${customMessage}\n\nCheck out this post: ${postLink}`
            : `Check out this post: ${postLink}`;
        
        try {
            // Send to all selected users
            for (const user of selectedShareUsers) {
                // Create or get conversation
                const conversation = await apiCall('/conversations/create/', {
                    method: 'POST',
                    body: JSON.stringify({ username: user.username })
                });
                
                // Send message
                await apiCall(`/conversations/${conversation.id}/messages/`, {
                    method: 'POST',
                    body: JSON.stringify({ text: messageText })
                });
            }
            
            // Show success feedback
            const tempMsg = document.createElement('div');
            tempMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 16px 24px; border-radius: 8px; z-index: 9999; font-size: 14px;';
            tempMsg.textContent = selectedShareUsers.length === 1 
                ? `Sent to ${selectedShareUsers[0].username}`
                : `Sent to ${selectedShareUsers.length} people`;
            document.body.appendChild(tempMsg);
            
            setTimeout(() => {
                tempMsg.remove();
            }, 2000);
            
            // Close modal
            closeModal('shareModal');
            
        } catch (error) {
            console.error('Error sharing post:', error);
            alert('Failed to share post. Please try again.');
        }
    }

    function viewArchive() {
        alert('View Archive feature coming soon!');
    }

    function openSettings() {
        document.getElementById('settingsModal').classList.add('active');
    }

    function createHighlight() {
        alert('Create Highlight feature coming soon!');
    }

    // Settings modal functions
    function openChangePassword() {
        closeModal('settingsModal');
        alert('Change password feature coming soon!');
    }

    function openNotificationSettings() {
        closeModal('settingsModal');
        alert('Notification settings coming soon!');
    }

    function openPrivacySettings() {
        closeModal('settingsModal');
        alert('Privacy and security settings coming soon!');
    }

    function openActivityLog() {
        closeModal('settingsModal');
        alert('Login activity coming soon!');
    }

    function openEmails() {
        closeModal('settingsModal');
        alert('Email preferences coming soon!');
    }

    function openHelp() {
        closeModal('settingsModal');
        window.open('https://help.instagram.com/', '_blank');
    }

    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/login';
    }

    // Followers Modal
    let allFollowers = [];
    async function openFollowersModal() {
        document.getElementById('followersModal').classList.add('active');
        document.getElementById('followersListContainer').innerHTML = '<div class="loading">Loading...</div>';
        
        try {
            // Use the profile being viewed, not the logged-in user
            const targetUsername = username === 'me' || !username || username === 'profile' 
                ? currentProfile.username 
                : username;
            const followers = await apiCall(`/profile/${targetUsername}/followers/`);
            allFollowers = followers;
            
            if (followers.length === 0) {
                document.getElementById('followersListContainer').innerHTML = 
                    '<div class="loading">No followers yet</div>';
                return;
            }

            renderFollowersList(followers);
            
            // Add search functionality
            document.getElementById('followersSearch').oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = allFollowers.filter(user => 
                    user && user.username && user.username.toLowerCase().includes(searchTerm)
                );
                renderFollowersList(filtered);
            };
        } catch (error) {
            console.error('Error loading followers:', error);
            document.getElementById('followersListContainer').innerHTML = 
                '<div class="loading">Failed to load followers</div>';
        }
    }

    async function renderFollowersList(followers) {
        const isOwnProfile = !username || username === 'me' || username === 'profile';
        
        // Get the profile being viewed (not the logged-in user)
        const profileBeingViewed = isOwnProfile ? currentProfile.username : username;
        
        // Enhanced filtering to completely hide logged-in user from ALL lists
        const filteredFollowers = followers.filter(user => {
            // Safety check for user object
            if (!user || !user.username) return false;
            
            // Debug logging
            console.log('Filtering follower:', user.username);
            console.log('currentProfile:', currentProfile);
            console.log('profileBeingViewed:', profileBeingViewed);
            
            // Remove the profile owner from their own list
            if (user.username === profileBeingViewed) {
                console.log('Removing profile owner from followers:', user.username);
                return false;
            }
            
            // Remove the logged-in user from ALL lists (prevent self-follow)
            if (currentProfile && user.username === currentProfile.username) {
                console.log('Removing logged-in user from followers (exact match):', user.username);
                return false;
            }
            
            // Additional safety check for case-insensitive comparison
            if (currentProfile && user.username.toLowerCase() === currentProfile.username.toLowerCase()) {
                console.log('Removing logged-in user from followers (case-insensitive):', user.username);
                return false;
            }
            
            // Also check against the current user from localStorage/auth
            const authUser = localStorage.getItem('username');
            if (authUser && user.username === authUser) {
                console.log('Removing logged-in user from followers (from localStorage):', user.username);
                return false;
            }
            
            console.log('Keeping follower:', user.username);
            return true;
        });
        
        let html = filteredFollowers.map(user => `
            <div class="user-list-item" data-username="${user.username}">
                <img src="${user.profile?.avatar || getDefaultAvatar(44)}" 
                     alt="${user.username}" 
                     class="user-list-avatar">
                <div class="user-list-info">
                    <a href="/profile/${user.username}" class="user-list-username">${user.username}</a>
                    <div class="user-list-name">${user.username}</div>
                </div>
                ${(() => {
                    // Double-check: Never show button for logged-in user
                    const authUser = localStorage.getItem('username');
                    if ((currentProfile && user.username === currentProfile.username) || 
                        (authUser && user.username === authUser)) {
                        console.log('Hiding follower button for logged-in user:', user.username);
                        return '';
                    }
                    
                    return isOwnProfile ? `
                        <button class="follow-btn-modal following remove-follower-btn" 
                                style="background: var(--secondary-bg); color: var(--text-primary);"
                                data-username="${user.username}"
                                onclick="event.stopPropagation(); removeFollower('${user.username}', this)">
                            Remove
                        </button>
                    ` : `
                        ${user.is_following ? `
                            <button class="follow-btn-modal message-btn" 
                                    style="background: var(--secondary-bg); color: var(--text-primary);"
                                    data-username="${user.username}"
                                    onclick="event.stopPropagation(); messageUserFromModal('${user.username}')">
                                Message
                            </button>
                        ` : ''}
                    `;
                })()}
            </div>
        `).join('');

        // Add suggestions if viewing own profile
        if (isOwnProfile) {
            try {
                const suggestions = await apiCall('/suggestions/');
                if (suggestions && suggestions.length > 0) {
                    html += `<div class="suggestions-header">Suggested for you</div>`;
                    html += suggestions.slice(0, 5).map(user => `
                        <div class="user-list-item" data-username="${user.username}">
                            <img src="${user.profile?.avatar || getDefaultAvatar(44)}" 
                                 alt="${user.username}" 
                                 class="user-list-avatar">
                            <div class="user-list-info">
                                <a href="/profile/${user.username}" class="user-list-username">${user.username}</a>
                                <div class="user-list-name">${user.username}</div>
                                <div class="user-list-subtitle">Suggested for you</div>
                            </div>
                            <button class="follow-btn-modal toggle-follow-btn" 
                                    data-username="${user.username}">
                                Follow
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading suggestions:', error);
            }
        }

        document.getElementById('followersListContainer').innerHTML = html;
        
        // Add event listeners for remove follower buttons
        document.querySelectorAll('.remove-follower-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                removeFollower(username, this);
            });
        });
        
        // Add event listeners for follow/unfollow buttons
        document.querySelectorAll('.toggle-follow-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                toggleFollowInModal(username, this);
            });
        });
        
        // Add event listeners for message buttons
        document.querySelectorAll('.message-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                messageUserFromModal(username);
            });
        });
    }

    let followerToRemove = null;
    let removeFollowerButton = null;

    async function removeFollower(username, button) {
        // Store the user and button for later use
        followerToRemove = allFollowers.find(u => u && u.username === username);
        removeFollowerButton = button;
        
        if (!followerToRemove) {
            console.error('Follower not found:', username);
            return;
        }
        
        // Show custom modal instead of browser confirm
        document.getElementById('removeFollowerUserAvatar').src = followerToRemove.profile?.avatar || getDefaultAvatar(90);
        document.getElementById('removeFollowerMessage').textContent = `Remove ${username} from followers?`;
        document.getElementById('removeFollowerModal').classList.add('active');
    }

    async function confirmRemoveFollower() {
        if (!followerToRemove || !removeFollowerButton) return;
        
        try {
            // Remove follower by making them unfollow you
            await apiCall(`/profile/${followerToRemove.username}/remove-follower/`, { method: 'POST' });
            
            // Remove from UI
            const item = removeFollowerButton.closest('.user-list-item');
            item.style.transition = 'opacity 0.3s';
            item.style.opacity = '0';
            setTimeout(() => {
                item.remove();
                allFollowers = allFollowers.filter(u => u && u.username !== followerToRemove.username);
            }, 300);
            
            // Update profile counts
            loadProfile();
            
            // Close modal
            closeModal('removeFollowerModal');
        } catch (error) {
            console.error('Error removing follower:', error);
            alert('Failed to remove follower. Please try again.');
        } finally {
            // Reset variables
            followerToRemove = null;
            removeFollowerButton = null;
        }
    }

    // Following Modal
    let allFollowing = [];
    let userToUnfollow = null;
    
    // Arrays are already declared earlier in the file
    
    async function openFollowingModal() {
        document.getElementById('followingModal').classList.add('active');
        document.getElementById('followingListContainer').innerHTML = '<div class="loading">Loading...</div>';
        
        try {
            // Use the profile being viewed, not the logged-in user
            const targetUsername = username === 'me' || !username || username === 'profile' 
                ? currentProfile.username 
                : username;
            const following = await apiCall(`/profile/${targetUsername}/following/`);
            allFollowing = following;
            
            if (following.length === 0) {
                document.getElementById('followingListContainer').innerHTML = 
                    '<div class="loading">Not following anyone yet</div>';
                return;
            }

            renderFollowingList(following);
            
            // Add search functionality
            document.getElementById('followingSearch').oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = allFollowing.filter(user => 
                    user && user.username && user.username.toLowerCase().includes(searchTerm)
                );
                renderFollowingList(filtered);
            };
        } catch (error) {
            console.error('Error loading following:', error);
            document.getElementById('followingListContainer').innerHTML = 
                '<div class="loading">Failed to load following</div>';
        }
    }

    function renderFollowingList(following) {
        const isOwnProfile = !username || username === 'me' || username === 'profile';
        
        // Get the profile being viewed (not the logged-in user)
        const profileBeingViewed = isOwnProfile ? currentProfile.username : username;
        
        // Enhanced filtering to completely hide logged-in user from ALL lists
        const filteredFollowing = following.filter(user => {
            // Safety check for user object
            if (!user || !user.username) return false;
            
            // Debug logging
            console.log('Filtering user:', user.username);
            console.log('currentProfile:', currentProfile);
            console.log('profileBeingViewed:', profileBeingViewed);
            
            // Remove the profile owner from their own list
            if (user.username === profileBeingViewed) {
                console.log('Removing profile owner:', user.username);
                return false;
            }
            
            // Remove the logged-in user from ALL lists (prevent self-follow)
            if (currentProfile && user.username === currentProfile.username) {
                console.log('Removing logged-in user (exact match):', user.username);
                return false;
            }
            
            // Additional safety check for case-insensitive comparison
            if (currentProfile && user.username.toLowerCase() === currentProfile.username.toLowerCase()) {
                console.log('Removing logged-in user (case-insensitive):', user.username);
                return false;
            }
            
            // Also check against the current user from localStorage/auth
            const authUser = localStorage.getItem('username');
            if (authUser && user.username === authUser) {
                console.log('Removing logged-in user (from localStorage):', user.username);
                return false;
            }
            
            console.log('Keeping user:', user.username);
            return true;
        });
        
        document.getElementById('followingListContainer').innerHTML = filteredFollowing.map(user => `
            <div class="user-list-item" data-username="${user.username}">
                <img src="${user.profile?.avatar || getDefaultAvatar(44)}" 
                     alt="${user.username}" 
                     class="user-list-avatar">
                <div class="user-list-info">
                    <a href="/profile/${user.username}" class="user-list-username">${user.username}</a>
                    <div class="user-list-name">${user.username}</div>
                </div>
                ${(() => {
                    // Double-check: Never show button for logged-in user
                    const authUser = localStorage.getItem('username');
                    if ((currentProfile && user.username === currentProfile.username) || 
                        (authUser && user.username === authUser)) {
                        console.log('Hiding button for logged-in user:', user.username);
                        return '';
                    }
                    
                    return isOwnProfile ? `
                        <button class="follow-btn-modal following unfollow-btn" 
                                data-username="${user.username}"
                                data-avatar="${user.profile?.avatar || getDefaultAvatar(44)}">
                            Following
                        </button>
                    ` : `
                        <button class="follow-btn-modal toggle-follow-btn ${user.is_following ? 'following' : ''}" 
                                data-username="${user.username}">
                            ${user.is_following ? 'Following' : 'Follow'}
                        </button>
                    `;
                })()}
            </div>
        `).join('');
        
        // Add event listeners for unfollow buttons
        document.querySelectorAll('.unfollow-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                const avatar = this.getAttribute('data-avatar');
                showUnfollowConfirmation(username, avatar);
            });
        });
        
        // Add event listeners for follow/unfollow buttons
        document.querySelectorAll('.toggle-follow-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                toggleFollowInModal(username, this);
            });
        });
    }

    function showUnfollowConfirmation(username, avatar) {
        userToUnfollow = username;
        document.getElementById('unfollowUserAvatar').src = avatar;
        document.getElementById('unfollowMessage').textContent = 
            `If you change your mind, you'll have to request to follow @${username} again.`;
        document.getElementById('unfollowModal').classList.add('active');
    }

    async function confirmUnfollow() {
        if (!userToUnfollow) return;
        
        try {
            await apiCall(`/profile/${userToUnfollow}/follow/`, { method: 'POST' });
            
            // Close unfollow modal
            closeModal('unfollowModal');
            
            // Remove from UI
            const item = document.querySelector(`[data-username="${userToUnfollow}"]`);
            if (item) {
                item.style.transition = 'opacity 0.3s';
                item.style.opacity = '0';
                setTimeout(() => {
                    item.remove();
                    allFollowing = allFollowing.filter(u => u && u.username !== userToUnfollow);
                }, 300);
            }
            
            // Update profile counts
            loadProfile();
            userToUnfollow = null;
        } catch (error) {
            console.error('Error unfollowing user:', error);
            alert('Failed to unfollow. Please try again.');
        }
    }

    // Toggle follow from modal
    async function toggleFollowInModal(username, button) {
        // Prevent double clicks
        if (button.disabled) return;
        button.disabled = true;
        
        const originalText = button.textContent.trim(); // Trim whitespace
        
        // Check if trying to follow self
        if (currentProfile && username === currentProfile.username) {
            console.warn('Cannot follow yourself');
            button.disabled = false;
            return;
        }
        
        console.log('Toggle follow for:', username, 'Button text:', `"${originalText}"`);
        
        try {
            // Show loading state
            button.textContent = 'Loading...';
            
            // First check if the user exists
            console.log('Checking if user exists:', username);
            try {
                const userProfile = await apiCall(`/profile/${username}/`);
                console.log('User profile found:', userProfile.username);
            } catch (profileError) {
                console.error('User profile not found:', profileError);
                throw new Error(`User ${username} not found`);
            }
            
            // Use the same API call as the working toggleFollow function
            console.log('Making follow API call for:', username);
            console.log('API endpoint:', `/profile/${username}/follow/`);
            console.log('Auth token present:', !!authToken);
            console.log('Auth token value:', authToken ? authToken.substring(0, 20) + '...' : 'null');
            console.log('Current user:', currentProfile?.username);
            
            // Test authentication first
            console.log('=== FRONTEND DEBUG ===');
            console.log('Auth token:', authToken ? 'Present' : 'Missing');
            console.log('CSRF token:', getCookie('csrftoken') ? 'Present' : 'Missing');
            console.log('API URL:', API_URL);
            console.log('Full endpoint:', `${API_URL}/profile/${username}/follow/`);
            console.log('=== END FRONTEND DEBUG ===');
            
            const response = await apiCall(`/profile/${username}/follow/`, { method: 'POST' });
            console.log('Follow response:', response);
            
            // Update button based on response status (same as working toggleFollow function)
            if (response.status === 'followed') {
                // Change to Message button after following
                button.textContent = 'Message';
                button.classList.remove('toggle-follow-btn', 'follow-back-btn');
                button.classList.add('message-btn');
                button.style.background = 'var(--secondary-bg)';
                button.style.color = 'var(--text-primary)';
                
                // Update event listener
                button.removeEventListener('click', arguments.callee);
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    messageUserFromModal(username);
                });
            } else if (response.status === 'unfollowed') {
                button.textContent = 'Follow back';
                button.classList.remove('following', 'message-btn');
                button.classList.add('toggle-follow-btn', 'follow-back-btn');
                button.style.background = '';
                button.style.color = '';
            } else {
                // Fallback - toggle based on current state
                if (button.classList.contains('following') || button.classList.contains('message-btn')) {
                    button.classList.remove('following', 'message-btn');
                    button.classList.add('toggle-follow-btn', 'follow-back-btn');
                    button.textContent = 'Follow back';
                    button.style.background = '';
                    button.style.color = '';
                } else {
                    button.classList.remove('toggle-follow-btn', 'follow-back-btn');
                    button.classList.add('message-btn');
                    button.textContent = 'Message';
                    button.style.background = 'var(--secondary-bg)';
                    button.style.color = 'var(--text-primary)';
                }
            }
            
            // Update the user in the arrays based on response
            const isNowFollowing = response.status === 'followed';
            if (allFollowers) {
                const followerUser = allFollowers.find(u => u && u.username === username);
                if (followerUser) {
                    followerUser.is_following = isNowFollowing;
                }
            }
            
            if (allFollowing) {
                const followingUser = allFollowing.find(u => u && u.username === username);
                if (followingUser) {
                    followingUser.is_following = isNowFollowing;
                }
            }
            
            // Reload profile to update counts
            loadProfile();
        } catch (error) {
            console.error('Error toggling follow:', error);
            console.error('Error details:', {
                message: error.message,
                status: error.status,
                username: username,
                originalText: originalText,
                currentProfile: currentProfile?.username
            });
            
            // Check if this is a self-follow attempt (should be prevented by earlier check)
            if (currentProfile && username === currentProfile.username) {
                console.warn('Self-follow attempt blocked');
                button.disabled = false;
                return; // Don't show error message for self-follow
            }
            
            // Check if the error response contains self-follow error
            const errorText = error.message || '';
            const isSelFollowError = errorText.includes('follow yourself') || 
                                   errorText.includes('cannot follow yourself') || 
                                   errorText.includes('You cannot follow yourself');
            
            if (isSelFollowError) {
                console.warn('Self-follow attempt blocked by backend');
                button.disabled = false;
                return; // Don't show error message or revert button for self-follow
            }
            
            // Revert button state on error (only for real errors)
            button.textContent = originalText;
            // Restore original classes based on original text
            if (originalText === 'Following' || originalText === 'Message') {
                button.classList.add('following');
                if (originalText === 'Message') {
                    button.classList.add('message-btn');
                    button.style.background = 'var(--secondary-bg)';
                    button.style.color = 'var(--text-primary)';
                }
            } else {
                button.classList.remove('following', 'message-btn');
                button.classList.add('toggle-follow-btn', 'follow-back-btn');
                button.style.background = '';
                button.style.color = '';
            }
            
            // Show user-friendly error message with more details (only for real errors)
            const action = (originalText === 'Following' || originalText === 'Message') ? 'unfollow' : 'follow';
            let errorMessage = `Failed to ${action} ${username}.`;
            
            // Try to get more specific error from response
            if (error.message.includes('401') || error.message.includes('403')) {
                errorMessage += ' Please log in again.';
                // Redirect to login after a delay
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else if (error.message.includes('404')) {
                errorMessage += ' User not found.';
            } else {
                errorMessage += ' Please try again.';
            }
            
            // Show alert for real errors only
            alert(errorMessage);
        } finally {
            // Re-enable button
            button.disabled = false;
        }
    }

    // Tab switching
    document.addEventListener('click', (e) => {
        if (e.target.closest('.profile-tab')) {
            const tab = e.target.closest('.profile-tab');
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const tabName = tab.getAttribute('data-tab');
            if (tabName === 'posts') {
                loadUserPosts(currentProfile.username);
            }
        }
    });

    // Story Functions
    async function loadUserStories() {
        try {
            const response = await apiCall('/stories/');
            
            // Handle both array and paginated response
            const stories = Array.isArray(response) ? response : (response.results || []);
            
            // Find stories for current profile user
            userStories = stories.filter(s => s && s.username === currentProfile.username);
            hasActiveStory = userStories.length > 0;
            
            // Re-render profile to show/hide story ring
            if (currentProfile) {
                renderProfile(currentProfile);
                loadUserPosts(currentProfile.username);
            }
        } catch (error) {
            console.error('Error loading stories:', error);
            userStories = [];
            hasActiveStory = false;
        }
    }

    function openAddStoryModal() {
        document.getElementById('addStoryModal').classList.add('active');
    }

    // Story image preview
    document.addEventListener('change', (e) => {
        if (e.target.id === 'storyImageInput') {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('storyPreview').src = e.target.result;
                    document.getElementById('storyPreviewContainer').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
    });

    // Upload story
    document.getElementById('addStoryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData();
        const imageFile = document.getElementById('storyImageInput').files[0];
        
        if (!imageFile) {
            alert('Please select an image');
            return;
        }
        
        formData.append('image', imageFile);
        
        try {
            const response = await fetch('/api/stories/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                },
                body: formData
            });
            
            if (!response.ok) throw new Error('Failed to create story');
            
            const story = await response.json();
            
            // Close modal and refresh
            closeModal('addStoryModal');
            document.getElementById('addStoryForm').reset();
            document.getElementById('storyPreviewContainer').style.display = 'none';
            
            // Reload stories
            await loadUserStories();
            
            alert('Story posted successfully! It will disappear in 24 hours.');
        } catch (error) {
            console.error('Error creating story:', error);
            alert('Failed to post story. Please try again.');
        }
    });

    // View profile story
    async function viewProfileStory() {
        if (userStories.length === 0) return;
        
        const story = userStories[0]; // Show most recent
        
        document.getElementById('storyViewerAvatar').src = story.user_avatar || getDefaultAvatar(44);
        document.getElementById('storyViewerUsername').textContent = story.username;
        document.getElementById('storyViewerTime').textContent = getTimeSince(new Date(story.created_at));
        document.getElementById('storyViewImage').src = story.image;
        
        document.getElementById('viewStoryModal').classList.add('active');
    }

    function getTimeSince(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
    }

    // Initialize
    if (authToken) {
        loadProfile().then(() => {
            loadUserStories();
        });
    } else {
        window.location.href = '/login';
    }
</script>
{% endblock %}
