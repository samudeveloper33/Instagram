{% extends 'base.html' %}

{% block title %}Post - Instagram Clone{% endblock %}

{% block extra_css %}
<style>
    .post-detail-container {
        max-width: 935px;
        margin: 40px auto;
        background: var(--primary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        display: flex;
    }

    .post-image-section {
        flex: 1;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        max-width: 600px;
    }

    .post-image-section img {
        width: 100%;
        height: auto;
        object-fit: contain;
        max-height: 80vh;
    }

    .post-info-section {
        width: 335px;
        display: flex;
        flex-direction: column;
        border-left: 1px solid var(--border-color);
    }

    .post-detail-header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .post-detail-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .post-detail-username {
        font-weight: 600;
        font-size: 14px;
        text-decoration: none;
        color: var(--text-primary);
    }

    .post-detail-options {
        margin-left: auto;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-primary);
    }

    .post-comments-section {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .post-caption-item {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .comment-item {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .comment-content {
        flex: 1;
    }

    .comment-username {
        font-weight: 600;
        font-size: 14px;
        margin-right: 8px;
        text-decoration: none;
        color: var(--text-primary);
    }

    .comment-text {
        font-size: 14px;
        color: var(--text-primary);
    }

    .comment-time {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
    }

    .post-detail-actions {
        padding: 6px 16px;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
    }

    .action-buttons {
        display: flex;
        gap: 16px;
        padding: 6px 0;
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        color: var(--text-primary);
        padding: 8px;
    }

    .action-btn.liked i {
        color: #ed4956;
    }

    .action-btn:hover {
        opacity: 0.6;
    }

    .post-detail-likes {
        font-weight: 600;
        font-size: 14px;
        padding: 8px 16px;
    }

    .post-detail-time {
        padding: 8px 16px;
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    .post-detail-comment-form {
        padding: 16px;
        border-top: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .post-detail-comment-form input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        background: transparent;
    }

    .post-detail-comment-form button {
        background: none;
        border: none;
        color: var(--link-color);
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
    }

    .post-detail-comment-form button:disabled {
        opacity: 0.3;
        cursor: default;
    }

    .loading {
        text-align: center;
        padding: 60px;
        color: var(--text-secondary);
    }

    @media (max-width: 768px) {
        .post-detail-container {
            flex-direction: column;
            margin: 0;
            border-radius: 0;
            border-left: none;
            border-right: none;
        }

        .post-image-section {
            max-width: 100%;
        }

        .post-info-section {
            width: 100%;
            border-left: none;
            border-top: 1px solid var(--border-color);
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="postDetailContainer">
    <div class="loading">Loading post...</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const postId = parseInt("{{ post_id }}");

    async function loadPostDetail() {
        try {
            const post = await apiCall(`/posts/${postId}/`);
            renderPostDetail(post);
        } catch (error) {
            console.error('Error loading post:', error);
            document.getElementById('postDetailContainer').innerHTML = 
                '<div class="loading">Failed to load post</div>';
        }
    }

    function renderPostDetail(post) {
        const timeSince = getTimeSince(new Date(post.created_at));
        
        const html = `
            <div class="post-detail-container">
                <div class="post-image-section">
                    ${post.video ? 
                        `<video src="${post.video}" controls style="max-width: 100%; max-height: 100%;"></video>` :
                        `<img src="${post.image}" alt="Post">`
                    }
                </div>
                <div class="post-info-section">
                    <div class="post-detail-header">
                        <img src="${post.author_avatar || getDefaultAvatar(32)}" 
                             alt="${post.author_username}" 
                             class="post-detail-avatar">
                        <a href="/profile/${post.author_username}" class="post-detail-username">
                            ${post.author_username}
                        </a>
                        <button class="post-detail-options" onclick="showPostOptions()">â‹¯</button>
                    </div>

                    <div class="post-comments-section" id="commentsSection">
                        ${post.caption ? `
                            <div class="post-caption-item">
                                <img src="${post.author_avatar || getDefaultAvatar(32)}" 
                                     alt="${post.author_username}" 
                                     class="comment-avatar">
                                <div class="comment-content">
                                    <div>
                                        <a href="/profile/${post.author_username}" class="comment-username">
                                            ${post.author_username}
                                        </a>
                                        <span class="comment-text">${post.caption}</span>
                                    </div>
                                    <div class="comment-time">${timeSince}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="commentsList">
                            ${post.comments.map(comment => `
                                <div class="comment-item">
                                    <img src="${comment.author_avatar || getDefaultAvatar(32)}" 
                                         alt="${comment.author_username}" 
                                         class="comment-avatar">
                                    <div class="comment-content">
                                        <div>
                                            <a href="/profile/${comment.author_username}" class="comment-username">
                                                ${comment.author_username}
                                            </a>
                                            <span class="comment-text">${comment.text}</span>
                                        </div>
                                        <div class="comment-time">${getTimeSince(new Date(comment.created_at))}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="post-detail-actions">
                        <div class="action-buttons">
                            <button class="action-btn ${post.is_liked ? 'liked' : ''}" onclick="toggleLike()" id="likeBtn">
                                <i class="${post.is_liked ? 'fas' : 'far'} fa-heart"></i>
                            </button>
                            <button class="action-btn" onclick="focusCommentInput()">
                                <i class="far fa-comment"></i>
                            </button>
                            <button class="action-btn">
                                <i class="far fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <div class="post-detail-likes">
                        <span id="likesCount">${post.likes_count}</span> likes
                    </div>

                    <div class="post-detail-time">${timeSince}</div>

                    <form class="post-detail-comment-form" onsubmit="addComment(event)">
                        <input type="text" placeholder="Add a comment..." id="commentInput">
                        <button type="submit" disabled id="commentBtn">Post</button>
                    </form>
                </div>
            </div>
        `;
        
        document.getElementById('postDetailContainer').innerHTML = html;

        // Enable/disable comment button
        document.getElementById('commentInput').addEventListener('input', (e) => {
            document.getElementById('commentBtn').disabled = !e.target.value.trim();
        });
    }

    async function toggleLike() {
        try {
            const response = await apiCall(`/posts/${postId}/like/`, { method: 'POST' });
            const likesElement = document.getElementById('likesCount');
            const likeBtn = document.getElementById('likeBtn');
            let likes = parseInt(likesElement.textContent);
            
            if (response.status === 'liked') {
                likeBtn.classList.add('liked');
                likeBtn.innerHTML = '<i class="fas fa-heart"></i>';
                likesElement.textContent = likes + 1;
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.innerHTML = '<i class="far fa-heart"></i>';
                likesElement.textContent = likes - 1;
            }
        } catch (error) {
            console.error('Error toggling like:', error);
        }
    }

    async function addComment(event) {
        event.preventDefault();
        const input = document.getElementById('commentInput');
        const text = input.value.trim();
        
        if (!text) return;
        
        try {
            await apiCall(`/posts/${postId}/comments/`, {
                method: 'POST',
                body: JSON.stringify({ text })
            });
            
            input.value = '';
            document.getElementById('commentBtn').disabled = true;
            
            // Reload post to show new comment
            loadPostDetail();
        } catch (error) {
            console.error('Error adding comment:', error);
            alert('Failed to add comment');
        }
    }

    function focusCommentInput() {
        document.getElementById('commentInput').focus();
    }

    function showPostOptions() {
        alert('Post options coming soon!');
    }

    function getTimeSince(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return `${seconds} seconds ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
        return `${Math.floor(seconds / 86400)} days ago`;
    }

    // Initialize
    if (authToken) {
        loadPostDetail();
    } else {
        window.location.href = '/login';
    }
</script>
{% endblock %}
